<html>
  <head>
    <meta charset="UTF-8">
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="../ElementsExtractor.js"></script>
    <script src="https://libs.zappar.com/zappar-aframe/2.0.1/zappar-aframe.js"></script>
    <script type="text/javascript">
      let API_KEY = '';
      let elmContainer;
      let outputText;
      let messageArray;
      //isEnglish=true: English, false: Japanese
      const isEnglish = true;

      window.onload=function(){
        //A-Frameのオブジェクトの追加先
        elmContainer = document.getElementById('container');
        //ChatGPTからの回答を表示するテキストエリア
        outputText=document.getElementById('output');
        //ChatGPTに送信するメッセージ。初期値はシステムの役割
        if(isEnglish){
          //initiliaze messageArray in English
          messageArray=[
            {role: "system", content: "You are an assistant that teaches me Primitive Element tags for A-Frame version 1.4.0 and later."}
          ];
        }else{
          //initiliaze messageArray in Japanese
          messageArray=[
            {role: "system", content: "あなたA-Frameバージョン1.4.0以降のPrimitive Elementのタグを教えるアシスタントです。"}
          ];
        }  
        let myImageGroup = document.getElementById("image-group");
        let imageVisible = false;
        myImageGroup.addEventListener("zappar-visible", () => {
            // The image has appeared so show the group
            myImageGroup.setAttribute("visible", "true");
            imageVisible = true;
        });
        
        myImageGroup.addEventListener("zappar-notvisible", () => {
            // The image has disappeared so hide the group after a short delay
            imageVisible = false;
            setTimeout(() => {
                if (imageVisible === false) myImageGroup.setAttribute("visible", "false");
            }, 500)
        });
      }
      //ボタンが押されたら
      async function OnClick() {
        outputText.value="Waiting...";
        //プロンプトをTexAreaから取得
        let prompt = document.getElementById('input').value;
        //promptがない場合
        if (!prompt){outputText.value="プロンプトを入力してください"; return};
        //プロンプトにオプションを追加
        if(isEnglish){
          prompt += 
          `Create an A-Frame element that starts with 'a-' to achieve the prompt above. Please follow these conditions:
          - Consider the current scene.
          - Do not use a-camera, a-assets, a-animation, a-sky or a-light.
          - Avoid using scripts.
          - Please provide the result in a code block.`;
        }
        else{
          prompt+=
          `上記を実現するA-Frameのa-から始まる要素を生成。ただし下記の条件を満たすこと。
          - 現在のシーンを踏まえること。
          - a-camera,a-assets,a-animation, a-sky,a-lightは使用しない。
          - scriptを使用しない。
          - 結果はコードブロックに記述。`;
        }
        //promptをmessageArrayに追加
        messageArray.push({role: "user", content: prompt});
        //ChatGPTにメッセージを送信
        let result = await SendMessage();
        //ChatGPTからの回答を表示
        outputText.value=("[Response]\n"+result+"\n\n");
        //ChatGPTからの回答からA-Frameの要素を抽出
        result = CreateElements(result);
        //A-Frameの要素を表示
        outputText.value+=("[Extracted Elements]\n"+result); 
        //Experimental: A-FrameのシーンのみをChatGPTからの回答として上書き
        messageArray[messageArray.length-1]={role: "assistant", content: "```html\n<a-scene>\n "+elmContainer.innerHTML+"\n </a-scene>\n``` "};       
      }
      //ChatGPTにメッセージを送信
      async function SendMessage() {
        //promptがある場合はリクエストを送信
        let response = await fetch('https://api.openai.com/v1/chat/completions', 
        {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            Authorization: `Bearer ${API_KEY}`,
          },
          body: JSON.stringify({
            model: "gpt-3.5-turbo",
            messages: messageArray, 
            temperature:0.3,
          }),
        });
        //レスポンスを受け取ったら、結果をjsonで取得
        let data = await response.json();
        let result;
        //ChatGPTからの回答があればメッセージ履歴に追加
        if(data.choices){
          //ChatGPTからの回答をテキストで取得
          result=data.choices[0].message.content;
          //ChatGPTからの回答をmessagesArrayに追加
          messageArray.push({role: "assistant", content: result});
          //messagesArrayの要素数が11を超えたら、1番目と2番目の要素(0スタート)を削除
          if(messageArray.length>11){ 
            messageArray.splice(1,2);
          }
        }else{
          result="No Response";
          //ChatGPTからの回答がなければ、最後の要素を削除
          messageArray.pop();
        }
        console.log(messageArray);
        return result;
      }
      //ChatGPTからの回答からA-Frameの要素を抽出
      function CreateElements(text){
        //textからA-Frameの要素を抽出
        let generatedElements = FindAframeElements(text);
        //resultに各要素のタグを追加
        let result="";//generatedElements.map(element => element.outerHTML).join("\n");
        //generatedElementsが空でなければcontainerに各要素を追加
        if(generatedElements.length>0){
          //containerから子要素を削除
          while (elmContainer.firstChild) {
            elmContainer.removeChild(elmContainer.firstChild);
          }
          //containerに各要素を追加
          generatedElements.forEach(element => {
            //elementをcontainerに追加
            elmContainer.appendChild(element); 
          });
        }else{
          result += "No A-Frame primitive element found.\n";
        }      
        return result; 
      }
    </script>
  </head>
  <body>
    <a-scene>    
       <!-- Ask user for camera permissions -->
        <a-entity zappar-permissions-ui id="permissions"></a-entity>
        <!-- Browser Compatibility -->
        <a-entity zappar-compatibility-ui id="compatibility"></a-entity>
        
        <a-entity camera zappar-camera></a-entity>

        <a-entity zappar-image="target:example-tracking-image.zpt" id="image-group">
            <a-entity id="container"></a-entity>
        </a-entity>
    </a-scene>
    <div style="position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); width: 90%;">
      <textarea id="input" style="font-size: 20px; width: 100%; height: 70px;">Enter a prompt</textarea>
      <button onclick="OnClick()" style="display: block; margin: 10px 0; width: 100%; height: 50px;">Submit</button>
      <textarea id="output" style="font-size: 18px; width: 100%; height: 70px;"></textarea>
    </div>
  </body>
</html>