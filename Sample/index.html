<html>
  <head>
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script type="text/javascript">
      let API_KEY = '';
      let container;
      let output;
      let messagesArray;
      window.onload=function(){
        container = document.getElementById('container');
        output=document.getElementById('output');
        messagesArray=[{role: "system", content: "あなたはA-FrameのPrimitive Elementを教えるエージェントです。"},{role: "user", content: "今日はよろしくお願いします。"}];
        sendPrompt();
      }
      
      async function sendPrompt(prompt = '') {
        //promptがない場合
        //if (!prompt){output.value="プロンプトを入力してください"; return};
        //promptがある場合はリクエストを送信
        const response = await fetch('https://api.openai.com/v1/chat/completions', 
          {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              Authorization: `Bearer ${API_KEY}`,
            },
            body: JSON.stringify({
              model: "gpt-3.5-turbo",
              messages: messagesArray, 
              temperature:0.7,
              }
            ),
          }
        );
      //レスポンスを受け取ったら、結果をjsonで取得
      const data = await response.json();
      //ChatGPTからの回答をテキストで取得
      var text=data.choices[0].message.content;
      output.value=(text+"\n\n");
      return text;
    }
    function useResult(text){
      // container要素の子要素を削除
       while (container.firstChild) {
        container.removeChild(container.firstChild);
      }
      
      //結果を表示する準備
      output.value+="[処理結果]\n";
    
      // <a-scene> と </a-scene> タグの間の内容、または全体の内容を抽出する正規表現
      const regex = /```(?:html)?\n(?:<a-scene>)?([\s\S]*?)(?:<\/a-scene>)?\n```/g;
      // コンテンツが見つかったかどうかを追跡する変数
      let foundContent = false;

      // コードブロック内のHTMLタグを処理する
      text.replace(regex, (match, contentToProcess) => {
        foundContent = true;
        // コードブロック内のHTMLタグを表示
        output.value += contentToProcess + "\n";
        // コードブロック内のHTMLタグを空のdiv要素に追加
        const elements = document.createElement('div');
        elements.innerHTML = contentToProcess.trim();
        // 各要素（オブジェクト）をcontainerに移動
        while (elements.firstChild) {
          container.appendChild(elements.firstChild);
        }
      });

      // 適切なHTMLタグが見つからなかった場合
      if (!foundContent) {
        // A-Frameのプリミティブ要素が見つからない旨のメッセージを表示
        output.value += 'No A-Frame primitive element found.\n';
      }   
    }
    async function onClick() {
      output.value="Wait...";
      //get text from textarea
      let prompt = document.getElementById('input').value;
      //promptがない場合
      if (!prompt){output.value="プロンプトを入力してください"; return};
      messagesArray[1]={role: "user", content: prompt+"\n 上記を実現するA-FrameのPrimitive ElementのHTMLタグをコードブロックで提供"};
      let result = await sendPrompt(prompt);
      useResult(result);
    }
    </script>
  </head>
  <body>
    <a-scene>
      <a-entity id="container"></a-entity>
      <a-sky color="#ECECEC"></a-sky>
    </a-scene>
    <div style="position: fixed; top: 20px; left: 20px; width: 20%;">
      <textarea id="input" style="font-size: 20px; width: 100%; height: 250px;"></textarea>
      <button onclick="onClick()" style="display: block; margin: 10px 0; width: 100%; height: 50px;">Submit</button>
      <textarea id="output" style="font-size: 18px; width: 100%; height: 250px;"></textarea>
    </div>
  </body>
</html>