<html>
  <head>
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script type="text/javascript">
      let API_KEY = '';
      let container;
      let output;
      let messagesArray;
      window.onload=function(){
        container = document.getElementById('container');
        output=document.getElementById('output');
        messagesArray=[{role: "system", content: "あなたA-Frameバージョン1.3.0以降のPrimitive Elementのタグを教えるエージェントです。"},{role: "user", content: "今日はよろしくお願いします。"}];
        sendPrompt();
      }
      
      async function sendPrompt(prompt = '') {
        //promptがない場合
        //if (!prompt){output.value="プロンプトを入力してください"; return};
        //promptがある場合はリクエストを送信
        const response = await fetch('https://api.openai.com/v1/chat/completions', 
          {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              Authorization: `Bearer ${API_KEY}`,
            },
            body: JSON.stringify({
              model: "gpt-3.5-turbo",
              messages: messagesArray, 
              temperature:0.3,
              }
            ),
          }
        );
      //レスポンスを受け取ったら、結果をjsonで取得
      const data = await response.json();
      //ChatGPTからの回答をテキストで取得
      var text=data.choices[0].message.content;
      output.value=(text+"\n\n");
      return text;
    }
    function useResult(text){
      //container要素の子要素を削除
      while (container.firstChild) {
        container.removeChild(container.firstChild);
      }
      
      //結果を表示する準備
      output.value+="[処理結果]\n";
    
      // <a-scene> と </a-scene> タグの間の内容、または全体の内容を抽出する正規表現
      //const regex = /```(?:html)?\n(?:<a-scene>)?([\s\S]*?)(?:<\/a-scene>)?\n```/g;
      const regex = /```(?:html)?\s*([\s\S]*?)```/g;
      let match;
      while ((match = regex.exec(text)) !== null) {
        const codeBlockContent = match[1];
        console.log("コードブロック内\n" + codeBlockContent);
        const sceneContentRegex = /<a-scene[^>]*>([\s\S]*?)<\/a-scene>/;
        const match2 = sceneContentRegex.exec(codeBlockContent);
        if (match2) {
          const sceneContent = match2[1];
          processSceneContent(sceneContent);
        } else {
          const fallbackRegex = /<a-[\w-]+[\s\S]*?(?:\/>|<\/a-[\w-]+>)/g;
          const matches = codeBlockContent.match(fallbackRegex);
          console.log("matches\n" + matches);
          // A-Frame のプリミティブ要素が見つかった場合
          if (matches) {
            const sceneContent = matches.join("\n");
            processSceneContent(sceneContent);
          }
          // A-Frame のプリミティブ要素が見つからなかった場合
          else {
            output.value += 'No A-Frame primitive element found.\n';
          }
        }
      }   
    }
    function processSceneContent(sceneContent) {
      console.log("タグ\n" + sceneContent);
      output.value += sceneContent + "\n";
      // containerに各要素を追加
      const elements = document.createElement('div');
      elements.innerHTML = sceneContent.trim();
      while (elements.firstChild) {
        if(elements.firstChild.outerHTML){
          container.appendChild(elements.firstChild);
        }else{
          elements.removeChild(elements.firstChild);
        }
      }
    }


    async function onClick() {
      output.value="Wait...";
      //get text from textarea
      let prompt = document.getElementById('input').value;
      //promptがない場合
      if (!prompt){output.value="プロンプトを入力してください"; return};
      //prompt+="\n <!DOCTYPE html>,<html>,<head>,<body>,<script>を絶対に使用しない。a-から始まるタグのみ使用可能。ただしa-cameraとa-assetsは使用しない。背景を変更する場合はa-skyを使用。結果はコードブロックに記述。";
      prompt+="\n 上記を実現するコードの中からaで始まるタグの行を抜き出して表示して。ただしa-camera,a-assets,a-animationは使用しない。結果はコードブロックに記述。";
      messagesArray[1]={role: "user", content: prompt};
      let result = await sendPrompt('');
      useResult(result); 
    }
    </script>
  </head>
  <body>
    <a-scene>
      <a-entity id="container"></a-entity>
      <!--<a-sky color="#ECECEC"></a-sky>-->
    </a-scene>
    <div style="position: fixed; top: 20px; left: 20px; width: 20%;">
      <textarea id="input" style="font-size: 20px; width: 100%; height: 250px;"></textarea>
      <button onclick="onClick()" style="display: block; margin: 10px 0; width: 100%; height: 50px;">Submit</button>
      <textarea id="output" style="font-size: 18px; width: 100%; height: 250px;"></textarea>
    </div>
  </body>
</html>