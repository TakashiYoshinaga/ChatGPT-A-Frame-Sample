<html>
  <head>
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script type="text/javascript">
    async function sendPrompt(prompt = '') {
      let API_KEY = ''
      let output=document.getElementById('output');
      output.value="Wait...";
      // promptがない場合
      if (!prompt){output.value="プロンプトを入力してください"; return};
      
      const response = await fetch('https://api.openai.com/v1/chat/completions', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          Authorization: `Bearer ${API_KEY}`,
        },
        body: JSON.stringify({
          model: "gpt-3.5-turbo",
          messages: [{role: "system", content: "あなたはA-FrameのPrimitive ElementのHTMLタグを提供します。"},{role: "user", content: prompt+"¥n上記のオブジェクトのPrimitive ElementのHTMLタグをコードブロックで提供。ただし<a-scene>は含まない。"}], 
          temperature:0.5,
        }),
      });
      
      const data = await response.json();
      var text=data.choices[0].message.content;
      console.log(data)
      output.value=text+"\n\n";
      const regex = /```(?:html)?\n([\s\S]*?)\n```/g;
      
      const aFrameTag = document.createElement('div');
      const container = document.getElementById('container');
      // container要素の子要素を削除
      while (container.firstChild) {
        container.removeChild(container.firstChild);
      }
      output.value+="[結果]\n";
      text.replace(regex, (match, htmlTag) => {
        console.log("code block: "+match);
        console.log("result: "+htmlTag);
        output.value+=htmlTag+"\n";
        const aFrameTag = document.createElement('div');
        aFrameTag.innerHTML = htmlTag.trim();
        while (aFrameTag.firstChild) {
          container.appendChild(aFrameTag.firstChild);
        }
      });
      
      if (!text.match(regex)) {
        console.log('No match found.');
        output.value+='No match found.';
        // ここにマッチしなかった場合の処理を記述
      }
    }
    
    function addBox() {
      //get text from textarea
      let prompt = document.getElementById('input').value;//document.querySelector('textarea').value;
      sendPrompt(prompt);
    }
    </script>
  </head>
  <body>
    <a-scene>
      <a-entity id="container"></a-entity>
      <a-sky color="#ECECEC"></a-sky>
    </a-scene>
    <div style="position: fixed; top: 20px; left: 20px; width: 20%;">
      <textarea id="input" style="font-size: 20px; width: 100%; height: 250px;"></textarea>
      <button onclick="addBox()" style="display: block; margin: 10px 0; width: 100%; height: 50px;">Submit</button>
      <textarea id="output" style="font-size: 18px; width: 100%; height: 250px;"></textarea>
    </div>
  </body>
</html>