<html>
  <head>
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="ElementsExtractor.js"></script>
    <script type="text/javascript">
      let API_KEY = '';
      let elmContainer;
      let outputText;
      let messageArray;

      window.onload=function(){
        elmContainer = document.getElementById('container');
        outputText=document.getElementById('output');
        messageArray=[
          {role: "system", content: "あなたA-Frameバージョン1.3.0以降のPrimitive Elementのタグを教えるエージェントです。"},
          {role: "user", content: "今日はよろしくお願いします。"}
        ];
        SendMessage();
      }
      //ChatGPTにメッセージを送信
      async function SendMessage() {
        //リクエストを送信
        const response = await fetch('https://api.openai.com/v1/chat/completions', 
          {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              Authorization: `Bearer ${API_KEY}`,
            },
            body: JSON.stringify({
              model: "gpt-3.5-turbo",
              messages: messageArray, 
              temperature:0.3,
              }
            ),
          }
        );
      //レスポンスを受け取ったら、結果をjsonで取得
      const data = await response.json();
      //ChatGPTからの回答をテキストで取得
      var text=data.choices[0].message.content;
      outputText.value=(text+"\n\n");
      return text;
    }
    //ChatGPTからの回答からA-Frameの要素を抽出
    function CreateElements(text){
      console.log("処理開始\n");
      //結果を表示する準備
      outputText.value+="[処理結果]\n";
      //textからA-Frameの要素を抽出
      const generatedElements = FindAframeElements(text);
      //generatedElementsが空でなければcontainerに各要素を追加
      if(generatedElements.length>0){
        //containerから子要素を削除
        while (elmContainer.firstChild) {
          elmContainer.removeChild(elmContainer.firstChild);
        }
        //containerに各要素を追加
        generatedElements.forEach(element => {
          //elementをcontainerに追加
          elmContainer.appendChild(element); 
          //elementのタグをoutputTextに追加(表示用)
          outputText.value += element.outerHTML + "\n";
        });
      }else{
        outputText.value += "No A-Frame primitive element found.\n";
      }
    }
    //ボタンが押されたら
    async function OnClick() {
      outputText.value="Waiting...";
      //プロンプトをTexAreaから取得
      let prompt = document.getElementById('input').value;
      //promptがない場合
      if (!prompt){outputText.value="プロンプトを入力してください"; return};
      //プロンプトをmessageArrayに追加
      prompt+="\n 上記を実現するコードの中からaで始まるタグの行を抜き出して表示して。ただしa-camera,a-assets,a-animationは使用しない。結果はコードブロックに記述。";
      messageArray[1]={role: "user", content: prompt};
      //ChatGPTにメッセージを送信
      let result = await SendMessage();
      //ChatGPTからの回答からA-Frameの要素を抽出
      CreateElements(result); 
    }
    </script>
  </head>
  <body>
    <a-scene>
      <a-entity id="container"></a-entity>
    </a-scene>
    <div style="position: fixed; top: 20px; left: 20px; width: 20%;">
      <textarea id="input" style="font-size: 20px; width: 100%; height: 250px;"></textarea>
      <button onclick="OnClick()" style="display: block; margin: 10px 0; width: 100%; height: 50px;">Submit</button>
      <textarea id="output" style="font-size: 18px; width: 100%; height: 250px;"></textarea>
    </div>
  </body>
</html>