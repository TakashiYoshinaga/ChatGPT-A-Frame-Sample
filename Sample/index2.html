<html>
  <head>
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="ElementsExtractor.js"></script>
    <script type="text/javascript">
      let API_KEY = '';
      let container;
      let output;
      let messagesArray;
     
      window.onload=function(){
        container = document.getElementById('container');
        output=document.getElementById('output');
        messagesArray=[{role: "system", content: "あなたA-Frameバージョン1.3.0以降のPrimitive Elementのタグを教えるエージェントです。"}];
        //sendPrompt("指示内容を実現するA-Frameのa-で始まるHTMLタグのみをコードブロックで提供。背景の変更を指示した場合はa-skyを使用。");
      }
      
      async function sendPrompt(prompt = '') {
        //promptがない場合
        if (!prompt){output.value="プロンプトを入力してください"; return};
        messagesArray.push({role: "user", content: prompt});
        //promptがある場合はリクエストを送信
        const response = await fetch('https://api.openai.com/v1/chat/completions', 
        {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            Authorization: `Bearer ${API_KEY}`,
          },
          body: JSON.stringify({
            model: "gpt-3.5-turbo",
            messages: messagesArray, 
            temperature:0.3,
          }),
        });
        console.log(messagesArray);
        //レスポンスを受け取ったら、結果をjsonで取得
        const data = await response.json();
        //ChatGPTからの回答をテキストで取得
        var text=data.choices[0].message.content;
        output.value=(text+"\n\n");
        console.log(data.choices[0].message);
        //ChatGPTからの回答をmessagesArrayに追加
        messagesArray.push({role: "assistant", content: text});
        //messagesArrayの要素数が7を超えたら、2番目と3番目の要素を削除
        if(messagesArray.length>7){ 
          messagesArray.splice(1,2);
        }
        return text;
      }
      
      function useResult(text){
        console.log("処理開始\n");
        
        //結果を表示する準備
        output.value+="[処理結果]\n";
     
        const generatedElements = FindAframeElements(text);

        //generatedElementsが空でなkればcontainerに各要素を追加
        if(generatedElements.length>0){
          //containerから子要素を削除
          while (container.firstChild) {
            container.removeChild(container.firstChild);
          }
          generatedElements.forEach(element => {
            container.appendChild(element); 
            output.value += element.outerHTML + "\n";
          });
        }else{
          output.value += "No A-Frame primitive element found.\n";
        } 
      }
      

      async function onClick() {
        output.value="Waiting...";
        //get text from textarea
        let prompt = document.getElementById('input').value;
        //let result = await sendPrompt(prompt + "\n <!DOCTYPE html>,<html>,<head>,<body>,<script>を絶対に使用しない。a-から始まるタグのみ使用可能。ただしa-cameraとa-assetsは使用しない。背景を変更する場合はa-skyを使用。結果はコードブロックに記述。");
        let result = await sendPrompt("今の情報を保ったまま"+prompt + "\n 上記を実現するA-FrameのPrimitive Elementのタグを生成。ただしa-camera,a-assets,a-animationは使用しない。結果はコードブロックに記述。");
        useResult(result);
      }
    </script>
  </head>
  <body>
    <a-scene>
      <a-entity id="container"></a-entity>
      <!--<a-sky color="#ECECEC"></a-sky>-->
    </a-scene>
    <div style="position: fixed; top: 20px; left: 20px; width: 20%;">
      <textarea id="input" style="font-size: 20px; width: 100%; height: 250px;"></textarea>
      <button onclick="onClick()" style="display: block; margin: 10px 0; width: 100%; height: 50px;">Submit</button>
      <textarea id="output" style="font-size: 18px; width: 100%; height: 250px;"></textarea>
    </div>
  </body>
</html>