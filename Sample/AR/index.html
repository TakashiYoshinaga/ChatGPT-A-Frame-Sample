<html>
  <head>
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="https://libs.zappar.com/zappar-aframe/2.0.1/zappar-aframe.js"></script>
    <script type="text/javascript">
      let API_KEY = '';
      let container;
      let output;
      let messagesArray;
      
      window.onload=function(){
        container = document.getElementById('container');
        output=document.getElementById('output');
        messagesArray=[{role: "system", content: "あなたはA-FrameのPrimitive Elementの教えるエージェントです。"}];
        sendPrompt("今日は指示内容を実現するA-FrameのPrimitive ElementのHTMLタグをコードブロックで提供。HTMLのソース全体は不要。削除の指示がないオブジェクトや背景の情報をそのままコードブロックに記述。背景の変更を指示した場合はa-skyを使用。");

        const myImageGroup = document.getElementById("image-group");
        let imageVisible = false;
        myImageGroup.addEventListener("zappar-visible", () => {
            // The image has appeared so show the group
            myImageGroup.setAttribute("visible", "true");
            imageVisible = true;
        });
        
        myImageGroup.addEventListener("zappar-notvisible", () => {
            // The image has disappeared so hide the group after a short delay
            imageVisible = false;
            setTimeout(() => {
                if (imageVisible === false) myImageGroup.setAttribute("visible", "false");
            }, 500)
        });
      }
      
      async function sendPrompt(prompt = '') {
        //promptがない場合
        if (!prompt){output.value="プロンプトを入力してください"; return};
        messagesArray.push({role: "user", content: prompt/*+"\n<a-scene>タグは絶対に記述しないでください。"*/});
        //promptがある場合はリクエストを送信
        const response = await fetch('https://api.openai.com/v1/chat/completions', 
        {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            Authorization: `Bearer ${API_KEY}`,
          },
          body: JSON.stringify({
            model: "gpt-3.5-turbo",
            messages: messagesArray, 
            temperature:0.5,
          }),
        });
        console.log(messagesArray);
        //レスポンスを受け取ったら、結果をjsonで取得
        const data = await response.json();
        //ChatGPTからの回答をテキストで取得
        var text=data.choices[0].message.content;
        output.value=(text+"\n\n");
        //ChatGPTからの回答をmessagesArrayに追加
        messagesArray.push({role: "assistant", content: text});
        //messagesArrayの要素数が7を超えたら、2番目と3番目の要素を削除
        console.log(messagesArray.length);
        if(messagesArray.length>11){ 
          messagesArray.splice(3,2);
        }
        return text;
      }
      
      function useResult(text){
        // container要素の子要素を削除
        while (container.firstChild) {
          container.removeChild(container.firstChild);
        }
        
        //結果を表示する準備
        //output.value+="[処理結果]\n";
     
        //<a-scene> と </a-scene> タグの間の内容、または全体の内容を抽出する正規表現
        //const regex = /```(?:html)?\n([\s\S]*?)\n```/g;
        //const regex = /(?:<a-scene>|```(?:html)?\n(?:<a-scene>)?)([\s\S]*?)(?:<\/a-scene>|(```))/g;
        const regex = /```(?:html)?\n(?:<a-scene>)?([\s\S]*?)(?:<\/a-scene>)?\n```/g;
        //コンテンツが見つかったかどうかを追跡する変数
        let foundContent = false;

        // コードブロック内のHTMLタグを処理する
        text.replace(regex, (match, contentToProcess) => {
          foundContent = true;
          // コードブロック内のHTMLタグを表示
          //output.value += contentToProcess + "\n";
          // コードブロック内のHTMLタグを空のdiv要素に追加
          const elements = document.createElement('div');
          elements.innerHTML = contentToProcess.trim();
          // 各要素（オブジェクト）をcontainerに移動
          while (elements.firstChild) {
            container.appendChild(elements.firstChild);
          }
        });
        
        // 適切なHTMLタグが見つからなかった場合
        if (!foundContent) {
          // A-Frameのプリミティブ要素が見つからない旨のメッセージを表示
          output.value += 'No A-Frame primitive element found.\n';
        }   
      }
      async function onClick() {
        output.value="Wait...";
        //get text from textarea
        let prompt = document.getElementById('input').value;
        let result = await sendPrompt(prompt);
        useResult(result);
      }
    </script>
  </head>
  <body>
    <a-scene>
      
       <!-- Ask user for camera permissions -->
        <a-entity zappar-permissions-ui id="permissions"></a-entity>
        <!-- Browser Compatibility -->
        <a-entity zappar-compatibility-ui id="compatibility"></a-entity>
        
        <a-entity camera zappar-camera></a-entity>

        <a-entity zappar-image="target:example-tracking-image.zpt" id="image-group">
            <!-- PLACE 3D OBJECTS HERE TO TRACK FROM THE CENTER OF THE IMAGE 
            <a-box position="0 0 0.5"></a-box>-->
            <a-entity id="container"></a-entity>
            <!--<a-gltf-model src="figure.glb" position="0 0 0" scale="20 20 20" rotation="90 0 0"></a-gltf-model>-->
        </a-entity>
      <!--<a-sky color="#ECECEC"></a-sky>-->
    </a-scene>
    <div style="position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); width: 90%;">
      <textarea id="input" style="font-size: 20px; width: 100%; height: 70px;"></textarea>
      <button onclick="onClick()" style="display: block; margin: 10px 0; width: 100%; height: 50px;">Submit</button>
      <textarea id="output" style="font-size: 18px; width: 100%; height: 70px;"></textarea>
    </div>
  </body>
</html>